--Long Ops
----------------------
select * from gv$session_longops
where sofar <> totalwork; 


--Sessions in DB..
-----------------
SELECT S.INST_ID, S.SID, S.SERIAL#, 
       S.SERVICE_NAME,
       P.PID, P.SPID OS_PID, 
       S.USERNAME, S.OSUSER, S.MACHINE, S.TERMINAL, S.PROGRAM,
       S.LOGON_TIME, S.TYPE,
       S.SQL_ID,
       DECODE(S.STATE, 'WAITING', 'WAITING','WORKING') STATE,
       S.LAST_CALL_ET, S.SECONDS_IN_WAIT,WAIT_TIME,
       S.EVENT, 
       S.MODULE, S.ACTION,
       S.P1, S.P1TEXT, S.P1RAW, 
       S.P2, S.P2TEXT, S.P2RAW,
       S.P3, S.P3TEXT, S.P3RAW,
       S.BLOCKING_SESSION B_SID, S.BLOCKING_INSTANCE B_INST, S.BLOCKING_SESSION_STATUS B_STATUS, 
       ROW_WAIT_OBJ#, O.OBJECT_TYPE, 
       O.OWNER|| CASE WHEN O.OWNER||O.OBJECT_NAME IS NOT NULL THEN '.' ELSE NULL END ||O.OBJECT_NAME OBJ_NAME,
       RESOURCE_CONSUMER_GROUP,
       S.ROW_WAIT_FILE#, S.ROW_WAIT_BLOCK#, S.ROW_WAIT_ROW#,
       ' ALTER SYSTEM KILL SESSION '|| chr(39) || s.sid || ',' || s.serial# || ',' || '@' || s.inst_id || chr(39) || ' IMMEDIATE ;' kill_session
FROM   GV$SESSION S
       LEFT OUTER JOIN GV$PROCESS P  ON S.INST_ID = P.INST_ID AND S.PADDR = P.ADDR
       LEFT OUTER JOIN DBA_OBJECTS O ON S.ROW_WAIT_OBJ# = O.OBJECT_ID
WHERE  S.TYPE <> 'BACKGROUND'       
--AND    S.USERNAME IN ('MDXODS_OCT')
--AND    UPPER(S.OSUSER) = 'NBKFSA1'
--AND    S.SID IN (679)    
--AND    S.SQL_ID = '8w7uv97yd7rqq'
AND    S.MODULE LIKE 'CORE_ISERIES_LOAN%'
AND    S.PROGRAM NOT LIKE '%(P%)%'
--AND    S.MACHINE = 'lpnoe0oy.pno-p01.chp.bankofamerica.com'
--ORDER BY 1, 2
; 

--------------------
-- TRACKE LONGOPS
--------------------
SELECT L.INST_ID, L.SID, L.SERIAL#, L.USERNAME,
       L.TARGET, L.TIME_REMAINING, 
       L.MESSAGE,  
       L.SQL_ID, S.SQL_TEXT
FROM   GV$SESSION_LONGOPS L INNER JOIN GV$SQL S ON S.SQL_ID = L.SQL_ID
WHERE  L.SOFAR <> L.TOTALWORK  
;

SELECT SID, EVENT, TOTAL_WAITS WAITS, TIME_WAITED*10 TOTALWAIT_MS,
       AVERAGE_WAIT*10 AVGWAIT_MS, MAX_WAIT*10 MAXWAIT_MS
FROM   gV$SESSION_EVENT
--WHERE  SID IN (1715)
ORDER BY WAITS DESC; 

SELECT ASH.INST_ID, ASH.SESSION_ID,  ASH.SESSION_SERIAL#, ASH.SAMPLE_TIME, ASH.SQL_ID, ASH.SQL_CHILD_NUMBER,
       ASH.SESSION_STATE, ASH.EVENT, ASH.WAIT_TIME, ASH.TIME_WAITED,
       ASH.PROGRAM, ASH.MODULE, ASH.ACTION,ASH.CONSUMER_GROUP_ID, RSG.NAME,
       IS_SQLID_CURRENT,TEMP_SPACE_ALLOCATED/1024/1024 TEMP_MB,
       ASH.SQL_EXEC_ID, ASH.SQL_EXEC_START,  ASH.SQL_PLAN_LINE_ID, ASH.SQL_PLAN_OPERATION, ASH.SQL_PLAN_OPTIONS        
FROM   GV$ACTIVE_SESSION_HISTORY ASH LEFT OUTER JOIN GV$RSRC_CONSUMER_GROUP RSG ON RSG.ID = ASH.CONSUMER_GROUP_ID AND RSG.INST_iD = ASH.INST_ID 
WHERE  ASH.INST_ID = 2 AND ASH.SESSION_ID IN 1909 AND ASH.SESSION_SERIAL# = 15959
ORDER BY ASH.SAMPLE_TIME DESC ;

SELECT   INST_ID,    SID, SERIAL#,   SQL_ID, TARGET,SOFAR, TOTALWORK, TIME_REMAINING,
         ELAPSED_SECONDS, USERNAME, MESSAGE, START_TIME,   LAST_UPDATE_TIME
FROM     GV$SESSION_LONGOPS
WHERE    SQL_ID = '3p6716xma9bba'
ORDER BY LAST_UPDATE_TIME DESC;

SELECT SESSION_STATE,WAIT_CLASS,EVENT, SUM(1) SECONDS,
       ROUND(RATIO_TO_REPORT(COUNT(*)) OVER () * 100, 1) PCT 
    FROM  GV$ACTIVE_SESSION_HISTORY
    GROUP BY SESSION_STATE,WAIT_CLASS,EVENT
    ORDER BY SECONDS DESC;

WITH DET AS
(
  SELECT 2 INST_ID, 1257 SID, 35961 SERIAL
  FROM   DUAL
),
STATS AS
(
  SELECT S.INST_ID, S.SID, N.NAME, S.VALUE 
  FROM   GV$STATNAME N, GV$SESSTAT  S , DET D
  WHERE  S.INST_ID    = N.INST_ID
  AND    S.STATISTIC# = N.STATISTIC#
  AND    S.INST_ID = D.INST_iD
  AND    S.SID = D.SID
)
SELECT * FROM STATS;

SELECT Q.SQL_TEXT, S.* FROM GV$SESSION S left outer join GV$SQL Q on S.SQL_ID = Q.SQL_ID  
WHERE s.SID = 1713
;

SELECT *
FROM   GV$ACTIVE_SESSION_HISTORY WHERE SQL_ID = 'fwk6chv29tfax';

SELECT  * 
FROM    GV$ACTIVE_SESSION_HISTORY H INNER JOIN MDXMD_XFR.JOB J ON J.JOBNAME = H.MODULE;



SELECT * 
FROM  GV$ACTIVE_SESSION_HISTORY 
WHERE SESSION_ID =  913
--AND   SESSION_SERIAL# = 10061;
